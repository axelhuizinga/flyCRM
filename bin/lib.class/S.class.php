<?php

// Generated by Haxe 3.4.7
class S {
	public function __construct(){}
	static $debug = true;
	static $headerSent = false;
	static $conf;
	static $my;
	static $host;
	static $request_scheme;
	static $user;
	static $db;
	static $dbHost;
	static $dbUser;
	static $dbPass;
	static $vicidialUser;
	static $vicidialPass;
	static function main() {
		haxe_Log::$trace = (property_exists("me_cunity_php_Debug", "_trace") ? me_cunity_php_Debug::$_trace: array("me_cunity_php_Debug", "_trace"));
		S::$conf = Config::load("appData.js");
		php_Session::start();
		$pd = php_Web::getPostData();
		$now = DateTools::format(Date::now(), "%d.%m.%y %H:%M:%S");
		haxe_Log::trace($pd, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 57, "className" => "S", "methodName" => "main")));
		$params = php_Web::getParams();
		if($params->get("debug") === "1") {
			header("Content-Type" . ": " . "text/html; charset=utf-8");
			S::$headerSent = true;
			php_Lib::println("<div><pre>");
			php_Lib::println($params);
		}
		$tmp = (property_exists("haxe_Log", "trace") ? haxe_Log::$trace: array("haxe_Log", "trace"));
		$tmp1 = Date::now()->toString();
		call_user_func_array($tmp, array($tmp1, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 66, "className" => "S", "methodName" => "main"))));
		haxe_Log::trace($params, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 67, "className" => "S", "methodName" => "main")));
		$action = $params->get("action");
		$tmp2 = null;
		if(strlen($action) !== 0) {
			$tmp2 = $params->get("className") === null;
		} else {
			$tmp2 = true;
		}
		if($tmp2) {
			S::dump(_hx_anonymous(array("error" => "required params missing")));
			return;
		}
		S::$my = new mysqli(S::$dbHost, S::$dbUser, S::$dbPass, S::$db, null, null);
		S::$my->set_charset("utf8");
		$auth = S::checkAuth();
		$tmp3 = (property_exists("haxe_Log", "trace") ? haxe_Log::$trace: array("haxe_Log", "trace"));
		$tmp4 = _hx_string_or_null($action) . ":" . Std::string($auth);
		call_user_func_array($tmp3, array($tmp4, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 81, "className" => "S", "methodName" => "main"))));
		if(!$auth) {
			S::hexit("AUTH FAILURE");
			return;
		}
		$result = Model::dispatch($params);
		haxe_Log::trace($result, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 89, "className" => "S", "methodName" => "main")));
		if(!S::$headerSent) {
			header("Content-Type" . ": " . "application/json");
			S::$headerSent = true;
		}
		php_Lib::println($result);
	}
	static function checkAuth() {
		S::$user = php_Session::get("PHP_AUTH_USER");
		haxe_Log::trace(S::$user, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 102, "className" => "S", "methodName" => "checkAuth")));
		if(S::$user === null) {
			return false;
		}
		$pass = php_Session::get("PHP_AUTH_PW");
		if($pass === null) {
			return false;
		}
		$res = _hx_deref(new Model(null))->query("SELECT use_non_latin,webroot_writable,pass_hash_enabled,pass_key,pass_cost,hosted_settings FROM system_settings");
		$res1 = php_Lib::hashOfAssociativeArray($res);
		$auth = "";
		try {
			$auth = user_authorization(S::$user, $pass, "", 1, -1, 1, 0);
			haxe_Log::trace($auth, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 121, "className" => "S", "methodName" => "checkAuth")));
		}catch(Exception $__hx__e) {
			$_ex_ = ($__hx__e instanceof HException) && $__hx__e->getCode() == null ? $__hx__e->e : $__hx__e;
			$ex = $_ex_;
			{
				haxe_Log::trace($ex, _hx_anonymous(array("fileName" => "S.hx", "lineNumber" => 125, "className" => "S", "methodName" => "checkAuth")));
			}
		}
		return _hx_index_of($auth, "GOOD", null) === 0;
	}
	static function hexit($d) {
		if(!S::$headerSent) {
			header("Content-Type" . ": " . "application/json");
			S::$headerSent = true;
		}
		$exitValue = json_encode(_hx_anonymous(array("ERROR" => $d)));
		exit($exitValue);
		return;
	}
	static function dump($d) {
		if(!S::$headerSent) {
			header("Content-Type" . ": " . "application/json");
			S::$headerSent = true;
		}
		php_Lib::println(haxe_Json::phpJsonEncode($d, null, null));
	}
	static function edump($d) {
		edump($d);
	}
	static function newMemberID() {
		$res = S::$my->query("SELECT  MAX(CAST(vendor_lead_code AS UNSIGNED)) FROM vicidial_list WHERE list_id=10000", null);
		if($res->num_rows === 0) {
			return 1;
		} else {
			return Std::parseInt(_hx_array_get($res->fetch_array(2), 0)) + 1;
		}
	}
	static function tableFields($table, $db = null) {
		if($db === null) {
			$db = "asterisk";
		}
		$res = S::$my->query("SELECT GROUP_CONCAT(COLUMN_NAME) FROM information_schema.columns WHERE table_schema = \"" . _hx_string_or_null($db) . "\" AND table_name = \"" . _hx_string_or_null($table) . "\";", null);
		$tmp = null;
		$tmp1 = null;
		$tmp2 = null;
		if($res !== null) {
			$tmp2 = $res !== 0;
		} else {
			$tmp2 = false;
		}
		if($tmp2) {
			$tmp1 = $res !== "";
		} else {
			$tmp1 = false;
		}
		if($tmp1) {
			$tmp = $res->num_rows === 1;
		} else {
			$tmp = false;
		}
		if($tmp) {
			$tmp3 = $res->fetch_array(2);
			return _hx_string_call($tmp3[0], "split", array(","));
		}
		return null;
	}
	function __toString() { return 'S'; }
}
{
	require_once("../../config/flyCRM.db.php");
	require_once("../../crm/functions.php");
	require_once("../../crm/loadAstguiclientConf.php");
	require_once("../agc/functions.fix.php");
	me_cunity_php_Debug::$logFile = $appLog;
	S::$db = $VARDB;
	S::$dbHost = $VARDB_server;
	S::$dbUser = $VARDB_user;
	S::$dbPass = $VARDB_pass;
	S::$host = $_SERVER['SERVER_NAME'];
	S::$request_scheme = $_SERVER['REQUEST_SCHEME'];
	S::$vicidialUser = $user;
	S::$vicidialPass = $pass;
}
